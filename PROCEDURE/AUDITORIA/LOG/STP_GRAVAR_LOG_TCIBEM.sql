CREATE OR REPLACE PROCEDURE STP_GRAVAR_LOG_TCIBEM
(
  P_TABELA IN VARCHAR2,
  P_CHAVE  IN VARCHAR2,
  P_CAMPO  IN VARCHAR2, 
  P_CODUSU IN INT,
  P_ACAO   IN VARCHAR2,
  P_NEW    IN VARCHAR2, 
  P_OLD    IN VARCHAR2  
)
AS
BEGIN 
DECLARE     

			V_USUARIO_BANCO 	VARCHAR2(60);
            V_USUARIO_REDE  	VARCHAR2(60);
            V_NOMEMAQUINA   	VARCHAR2(60);
            V_IPMAQUINA     	VARCHAR2(60);
            V_PROGRAMA      	VARCHAR2(60);
            V_USUARIOSIS    	VARCHAR2(60);
            V_CODUSUAUX     	VARCHAR2(100);
			V_CURRENT_SCHEMA 	VARCHAR2(100);
			V_NLS_TERRITORY 	VARCHAR2(100);
			V_OS_USER 			VARCHAR2(100);
            V_NOMEUSUSANKHYA    VARCHAR2(400);            
			DATAOPERACAO 	 	TIMESTAMP DEFAULT SYSTIMESTAMP;
            V_NUNICO            INT;

BEGIN 



    IF (P_CODUSU IS NULL) OR (P_CODUSU = 0) OR (P_TABELA = 'TSIUSU') THEN

      V_CODUSUAUX := TSIUSU_LOG_PKG.V_CODUSULOG;
      V_USUARIOSIS := TSIUSU_LOG_PKG.V_NOMEUSULOG;

    ELSE

      V_CODUSUAUX := P_CODUSU;

      BEGIN

        SELECT 
			 USU.NOMEUSU 
		INTO V_USUARIOSIS 
		FROM TSIUSU USU 
		WHERE USU.CODUSU = V_CODUSUAUX;

      EXCEPTION WHEN NO_DATA_FOUND THEN
        V_USUARIOSIS := 'USUARIO NAO LOCALIZADO NA TSIUSU ' || V_CODUSUAUX;
      END;

    END IF;

    SELECT   
        USERNAME, 
        OSUSER,
        MACHINE,
        SYS_CONTEXT('USERENV','IP_ADDRESS'),
        PROGRAM,
		SYS_CONTEXT('USERENV','CURRENT_SCHEMA'),
		SYS_CONTEXT('USERENV','NLS_TERRITORY'),
		SYS_CONTEXT('USERENV','OS_USER')
    INTO
        V_USUARIO_BANCO,
        V_USUARIO_REDE,
        V_NOMEMAQUINA,
        V_IPMAQUINA,
        V_PROGRAMA,
		V_CURRENT_SCHEMA,
		V_NLS_TERRITORY,
		V_OS_USER
    FROM
        V$SESSION
    WHERE  AUDSID = (SELECT USERENV('SESSIONID') FROM DUAL)
        AND ROWNUM = 1;

    STP_KEYGEN_TGFNUM('TCIBEM',1,'TCIBEM', 'NUNOTA', 0, V_NUNICO);

    V_CODUSUAUX  := TSIUSU_LOG_PKG.V_CODUSULOG;

    SELECT 
	USU.NOMEUSU 
	INTO V_NOMEUSUSANKHYA 
	FROM TSIUSU USU 
	WHERE USU.CODUSU = V_CODUSUAUX;

    INSERT INTO AD_TCIBEMLOG
    (
        NUNICO,
        NOMETAB,
        DHACAO,
        ACAO,
        USUBANCO,
        USUREDE,
        NOMMAQUINA,
        IPMAQUINA,
        PROGRAMA,
        USULANC,
        CHAVE,
        CAMPO,
        NOVO,
        VELHO,
		DATAOPERACAO,
        AD_CURRENT_SCHEMA,
		AD_NLS_TERRITORY,
		AD_OS_USER,
        CODUSUSANKHYA,
        NOMEUSUSANKHYA        
    )
    VALUES
    (
        V_NUNICO,
        P_TABELA,
        SYSDATE,
        P_ACAO,
        V_USUARIO_BANCO,
        V_USUARIO_REDE,
        V_NOMEMAQUINA,
        V_IPMAQUINA,
        V_PROGRAMA,
        V_USUARIOSIS,
        P_CHAVE,
        P_CAMPO,
        P_NEW,
        P_OLD,
		SYSTIMESTAMP,
		V_CURRENT_SCHEMA,
		V_NLS_TERRITORY,
		V_OS_USER,
        V_CODUSUAUX,
        V_NOMEUSUSANKHYA        
    );
EXCEPTION 
	WHEN NO_DATA_FOUND THEN
	RAISE_APPLICATION_ERROR(-20101, 'Dados n√£o encontrados, entre em contato com o administrador do sistema');

END;

END STP_GRAVAR_LOG_TCIBEM;
