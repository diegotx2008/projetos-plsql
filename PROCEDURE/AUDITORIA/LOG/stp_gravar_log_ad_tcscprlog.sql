PROMPT CREATE OR REPLACE PROCEDURE stp_gravar_log_ad_tcscprlog
CREATE OR REPLACE PROCEDURE stp_gravar_log_ad_tcscprlog
(
	P_OBJETO IN VARCHAR2,
	P_CHAVE  IN VARCHAR2,
	P_ACAO   IN VARCHAR2,
	P_NUMCONTRATO TCSCPR.NUMCONTRATO%TYPE,
	P_GRUPO IN INT,
	P_GRUPO_OLD IN INT,
	P_CODPROD  TCSCPR.CODPROD%TYPE,
	P_CODPROD_OLD TCSCPR.CODPROD%TYPE,
	P_CODUSU IN VARCHAR2,
	P_QTDPED 		TCSCPR.QTDPED%TYPE,
	P_QTDPED_OLD 	TCSCPR.QTDPED%TYPE,
	P_QTDPEDVDA 	TCSCPR.QTDPEDVDA%TYPE,
	P_QTDPEDVDA_OLD TCSCPR.QTDPEDVDA%TYPE,
	P_QTDNEG 		TCSCPR.QTDNEG%TYPE,
	P_QTDNEG_OLD 	TCSCPR.QTDNEG%TYPE,
  P_VALOR 	TCSCPR.VALOR%TYPE,
  P_VALOR_OLD TCSCPR.VALOR%TYPE
)
AS
BEGIN
DECLARE

			V_USUARIO_BANCO 	VARCHAR2(200);
            V_USUARIO_REDE  	VARCHAR2(200);
            V_NOMEMAQUINA   	VARCHAR2(200);
            V_IPMAQUINA     	VARCHAR2(200);
            V_PROGRAMA      	VARCHAR2(200);
            V_USUARIOSIS    	VARCHAR2(200);
            V_CODUSUAUX     	INT;
			V_CURRENT_SCHEMA 	VARCHAR2(200);
			V_NLS_TERRITORY 	VARCHAR2(200);
			V_OS_USER 			VARCHAR2(200);
			DATAOPERACAO 	 	TIMESTAMP DEFAULT SYSTIMESTAMP;
            V_NUNICO            INT;


BEGIN


    IF (P_CODUSU IS NULL) OR (P_CODUSU = 0) THEN

      V_CODUSUAUX := TSIUSU_LOG_PKG.V_CODUSULOG;
      V_USUARIOSIS := TSIUSU_LOG_PKG.V_NOMEUSULOG;

    ELSE

      V_CODUSUAUX := P_CODUSU;

      BEGIN

        SELECT
			 USU.NOMEUSU
		INTO V_USUARIOSIS
		FROM TSIUSU USU
		WHERE USU.CODUSU = V_CODUSUAUX;

      EXCEPTION WHEN NO_DATA_FOUND THEN
        V_USUARIOSIS := 'USUARIO NAO LOCALIZADO NA TSIUSU ' || V_CODUSUAUX;
      END;

    END IF;

    SELECT
        USERNAME,
        OSUSER,
        MACHINE,
        SYS_CONTEXT('USERENV','IP_ADDRESS'),
        PROGRAM,
		SYS_CONTEXT('USERENV','CURRENT_SCHEMA'),
		SYS_CONTEXT('USERENV','NLS_TERRITORY'),
		SYS_CONTEXT('USERENV','OS_USER')
    INTO
        V_USUARIO_BANCO,
        V_USUARIO_REDE,
        V_NOMEMAQUINA,
        V_IPMAQUINA,
        V_PROGRAMA,
		V_CURRENT_SCHEMA,
		V_NLS_TERRITORY,
		V_OS_USER
    FROM
        V$SESSION
    WHERE  AUDSID = (SELECT USERENV('SESSIONID') FROM DUAL)
        AND ROWNUM = 1;

    STP_KEYGEN_TGFNUM('AD_TCSCPRLOG',1,'AD_TCSCPRLOG', 'NUNICO', 0, V_NUNICO);

    V_CODUSUAUX  := TSIUSU_LOG_PKG.V_CODUSULOG;

    INSERT INTO AD_TCSCPRLOG
    (
        NUNICO,
        OBJETO,
        DHACAO,
        ACAO,
        USUBANCO,
        USUREDE,
        NOMEMAQUINA,
        IPMAQUINA,
        PROGRAMA,
        USULANC,
        CHAVE,
		DATAOPERACAO,
        AD_CURRENT_SCHEMA,
		AD_OS_USER,
        CODUSUSANKHYA,
		NUMCONTRATO,
		GRUPO,
		GRUPO_OLD,
		CODPROD,
		CODPROD_OLD,
		CODUSU,
		QTDPED,
		QTDPED_OLD,
		QTDPEDVDA,
		QTDPEDVDA_OLD,
		QTDNEG,
		QTDNEG_OLD,
    VALOR,
    VALOR_OLD
    )
    VALUES
    (
        V_NUNICO,
        P_OBJETO,
        SYSTIMESTAMP,
        P_ACAO,
        V_USUARIO_BANCO,
        V_USUARIO_REDE,
        V_NOMEMAQUINA,
        V_IPMAQUINA,
        V_PROGRAMA,
        V_USUARIOSIS,
		P_CHAVE,
		SYSDATE,
		V_CURRENT_SCHEMA,
        V_CODUSUAUX,
        V_CODUSUAUX,
		TO_CHAR(P_NUMCONTRATO,'999999999999'),
		TO_CHAR(P_GRUPO,'999999999999'),
		TO_CHAR(P_GRUPO_OLD,'999999999999'),
		TO_CHAR(P_CODPROD,'999999999999'),
		TO_CHAR(P_CODPROD_OLD,'999999999999'),
		P_CODUSU,
		P_QTDPED,
		P_QTDPED,
		P_QTDPEDVDA,
		P_QTDPEDVDA_OLD,
		P_QTDNEG,
		P_QTDNEG_OLD,
    P_VALOR,
    P_VALOR_OLD
    );
END;

END;


